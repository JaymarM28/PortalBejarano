<app-notifications></app-notifications>

<div class="dashboard-layout">
  <!-- Sidebar -->
  <aside class="sidebar" [class.expanded]="sidebarExpanded" [class.mobile-open]="mobileSidebarOpen">
    <div class="sidebar-header">
      <div class="logo">
        <span class="logo-icon">ğŸ </span>
        <span class="logo-text">Portal</span>
      </div>
      <button class="btn-close-mobile" (click)="toggleMobileSidebar()">Ã—</button>
    </div>

    <nav class="sidebar-nav">
      <a 
        class="nav-item" 
        [class.active]="activeTab === 'payments'" 
        (click)="setActiveTab('payments')">
        <span class="nav-icon">ğŸ“‹</span>
        <span class="nav-text">Pagos</span>
      </a>
      
      <a 
        class="nav-item" 
        [class.active]="activeTab === 'employees'" 
        (click)="setActiveTab('employees')">
        <span class="nav-icon">ğŸ‘¤</span>
        <span class="nav-text">Empleadas</span>
      </a>
      
      <a 
        class="nav-item" 
        [class.active]="activeTab === 'expenses'" 
        (click)="setActiveTab('expenses')">
        <span class="nav-icon">ğŸ›’</span>
        <span class="nav-text">Gastos</span>
      </a>
      
      <a 
        *ngIf="authService.canManageUsers()"
        class="nav-item" 
        [class.active]="activeTab === 'users'" 
        (click)="setActiveTab('users')">
        <span class="nav-icon">ğŸ‘¥</span>
        <span class="nav-text">Usuarios</span>
      </a>
      
      <a 
        *ngIf="currentUser?.role === 'super_admin'"
        class="nav-item" 
        [class.active]="activeTab === 'houses'" 
        (click)="setActiveTab('houses')">
        <span class="nav-icon">ğŸ˜ï¸</span>
        <span class="nav-text">Casas</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <a class="nav-item" (click)="openChangePasswordModal()">
        <span class="nav-icon">ğŸ”</span>
        <span class="nav-text">ContraseÃ±a</span>
      </a>
      <a class="nav-item logout" (click)="logout()">
        <span class="nav-icon">ğŸšª</span>
        <span class="nav-text">Salir</span>
      </a>
    </div>
  </aside>

  <!-- Overlay para mobile -->
  <div class="sidebar-overlay" *ngIf="mobileSidebarOpen" (click)="toggleMobileSidebar()"></div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <header class="dashboard-header">
      <button class="btn-menu-mobile" (click)="toggleMobileSidebar()">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="header-left">
        <h1>Sistema de Pagos</h1>
        <small *ngIf="currentHouse">{{ currentHouse.name }}</small>
      </div>
      <div class="user-info">
        <span class="user-name">{{ currentUser?.fullName }}</span>
        <span class="badge">
          {{ currentUser?.role === 'super_admin' ? 'Super Admin' : 
             currentUser?.role === 'admin_house' ? 'Admin Casa' : 'Admin' }}
        </span>
      </div>
    </header>

    <!-- Content -->
    <div class="content">
      <!-- Payments Tab -->
      <div *ngIf="activeTab === 'payments'" class="tab-content">
        <div class="tab-header">
          <h2>Historial de Pagos</h2>
          <div class="header-actions">
            <button class="btn-secondary" (click)="exportToExcel()" [disabled]="filteredPayments.length === 0">
              <span class="btn-icon-only">ğŸ“Š</span>
              <span class="btn-text">Exportar a Excel</span>
            </button>
            <button class="btn-primary" (click)="openPaymentModal()">
              <span class="btn-icon-only">+</span>
              <span class="btn-text">Nuevo Pago</span>
            </button>
          </div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
          <div class="filter-group full-width">
            <input 
              type="text" 
              [(ngModel)]="searchTerm" 
              placeholder="ğŸ” Buscar por empleada o empleador..."
              class="filter-input">
          </div>
          
          <div class="filter-row">
            <div class="filter-group">
              <label>Empleada:</label>
              <select [(ngModel)]="filterEmployee" class="filter-select">
                <option value="">Todas las empleadas</option>
                <option *ngFor="let emp of employees" [value]="emp.id">{{ emp.fullName }}</option>
              </select>
            </div>

            <div class="filter-group">
              <label>Desde:</label>
              <input type="date" [(ngModel)]="filterDateFrom" class="filter-input">
            </div>

            <div class="filter-group">
              <label>Hasta:</label>
              <input type="date" [(ngModel)]="filterDateTo" class="filter-input">
            </div>

            <button class="btn-link" (click)="clearFilters()">Limpiar</button>
          </div>

          <div class="filter-results" *ngIf="filteredPayments.length !== payments.length">
            Mostrando {{ filteredPayments.length }} de {{ payments.length }} pagos
          </div>
        </div>
        
        <app-skeleton [loading]="loadingPayments" [type]="'payment-table'"></app-skeleton>

        <div class="table-responsive" *ngIf="!loadingPayments && filteredPayments.length > 0">
          <table class="data-table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Empleada</th>
                <th>Empleador</th>
                <th>Monto Total</th>
                <th>Estado</th>
                <th class="actions-column">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let payment of filteredPayments">
                <td data-label="Fecha">{{ payment.paymentDate | date: 'dd/MM/yyyy' }}</td>
                <td data-label="Empleada">{{ payment.employee.fullName }}</td>
                <td data-label="Empleador">{{ payment.employer.fullName }}</td>
                <td data-label="Monto">${{ payment.totalAmount | number: '1.2-2' }}</td>
                <td data-label="Estado">
                  <span class="status" [class.pending]="payment.status === 'pending'" 
                        [class.signed]="payment.status === 'signed'"
                        [class.completed]="payment.status === 'completed'">
                    {{ payment.status === 'pending' ? 'Pendiente' : 
                       payment.status === 'signed' ? 'Firmado' : 'Completado' }}
                  </span>
                </td>
                <td class="actions-column" data-label="Acciones">
                  <div class="action-buttons">
                    <button class="btn-icon" (click)="downloadPDF(payment.id)" title="Descargar PDF">ğŸ“„</button>
                    <button *ngIf="payment.status === 'pending'" class="btn-icon" (click)="openSignatureModal(payment)" title="Firmar">âœï¸</button>
                    <button
                      *ngIf="payment.status === 'pending' && (currentUser?.role === 'super_admin' || currentUser?.role === 'admin_house')"
                      class="btn-icon"
                      (click)="openEditPaymentModal(payment)"
                      title="Editar">âœï¸</button>
                    <button *ngIf="currentUser?.role === 'super_admin' || currentUser?.role === 'admin_house'" 
                            class="btn-icon btn-danger" 
                            (click)="deletePayment(payment.id)" 
                            title="Eliminar">ğŸ—‘ï¸</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="empty-state" *ngIf="!loadingPayments && payments.length === 0">
          <p>ğŸ“‹ No hay pagos registrados todavÃ­a</p>
        </div>
      </div>

      <!-- Employees Tab -->
      <div *ngIf="activeTab === 'employees'" class="tab-content">
        <div class="tab-header">
          <h2>Empleadas</h2>
          <button class="btn-primary" (click)="openEmployeeModal()">
            <span class="btn-icon-only">+</span>
            <span class="btn-text">Nueva Empleada</span>
          </button>
        </div>

        <app-skeleton [loading]="loadingEmployees" [type]="'employee-card'"></app-skeleton>

        <div class="cards-grid" *ngIf="!loadingEmployees">
          <div *ngFor="let employee of employees" class="card">
            <div class="card-header">
              <h3>{{ employee.fullName }}</h3>
              <span class="badge" [class.inactive]="!employee.isActive">
                {{ employee.isActive ? 'Activa' : 'Inactiva' }}
              </span>
            </div>
            <div class="card-body">
              <p><strong>Documento:</strong> {{ employee.documentId }}</p>
              <p *ngIf="employee.phone"><strong>TelÃ©fono:</strong> {{ employee.phone }}</p>
              <p><strong>Salario:</strong> ${{ employee.baseSalary | number: '1.2-2' }}</p>
            </div>
            <div class="card-actions">
              <button class="btn-sm" (click)="openEmployeeModal(employee)">âœï¸ Editar</button>
              <button class="btn-sm btn-danger" (click)="deleteEmployee(employee.id)">ğŸ—‘ï¸ Eliminar</button>
            </div>
          </div>
        </div>

        <div class="empty-state" *ngIf="!loadingEmployees && employees.length === 0">
          <p>ğŸ‘¤ No hay empleadas registradas todavÃ­a</p>
        </div>
      </div>

    <!-- Expenses Tab -->
<div *ngIf="activeTab === 'expenses'" class="tab-content">
  <div class="tab-header">
    <h2>Gastos de Mercado</h2>

    <div class="header-actions">
      <button class="btn-secondary"
              (click)="exportMarketExpensesToExcel()"
              [disabled]="filteredMarketExpenses.length === 0">
        <span class="btn-icon-only">ğŸ“Š</span>
        <span class="btn-text">Exportar a Excel</span>
      </button>

      <button class="btn-primary" (click)="openMarketExpenseModal()">
        <span class="btn-icon-only">+</span>
        <span class="btn-text">Nuevo Gasto</span>
      </button>
    </div>
  </div>

  <!-- EstadÃ­sticas del Mes -->
  <div class="stats-section" *ngIf="monthStats">
    <h3>ğŸ“Š EstadÃ­sticas del Mes</h3>

    <div class="month-selector">
      <label>Mes:</label>
      <select [(ngModel)]="selectedMonth" (change)="onMonthYearChange()" class="filter-select">
        <option [value]="1">Enero</option>
        <option [value]="2">Febrero</option>
        <option [value]="3">Marzo</option>
        <option [value]="4">Abril</option>
        <option [value]="5">Mayo</option>
        <option [value]="6">Junio</option>
        <option [value]="7">Julio</option>
        <option [value]="8">Agosto</option>
        <option [value]="9">Septiembre</option>
        <option [value]="10">Octubre</option>
        <option [value]="11">Noviembre</option>
        <option [value]="12">Diciembre</option>
      </select>

      <label>AÃ±o:</label>
      <input type="number"
             [(ngModel)]="selectedYear"
             (change)="onMonthYearChange()"
             class="filter-input year-input">
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total del Mes</div>
        <div class="stat-value">${{ monthStats.total | number: '1.2-2' }}</div>
        <div class="stat-subtitle">{{ monthStats.count }} compras</div>
      </div>

      <div class="stat-card" *ngIf="monthStats.byResponsible.length > 0">
        <div class="stat-label">Por Responsable</div>
        <div class="stat-list">
          <div *ngFor="let item of monthStats.byResponsible" class="stat-item">
            <span>{{ item.name }}</span>
            <span class="stat-amount">${{ item.total | number: '1.2-2' }}</span>
          </div>
        </div>
      </div>

      <div class="stat-card" *ngIf="monthStats.byPlace.length > 0">
        <div class="stat-label">Por Lugar</div>
        <div class="stat-list">
          <div *ngFor="let item of monthStats.byPlace" class="stat-item">
            <span>{{ item.place }}</span>
            <span class="stat-amount">${{ item.total | number: '1.2-2' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-section">
    <div class="filter-group full-width">
      <input
        type="text"
        [(ngModel)]="expenseSearchTerm"
        placeholder="ğŸ” Buscar por lugar o responsable..."
        class="filter-input">
    </div>

    <div class="filter-row">
      <div class="filter-group">
        <label>Responsable:</label>
        <select [(ngModel)]="expenseFilterResponsible" class="filter-select">
          <option value="">Todos</option>
          <option *ngFor="let user of users" [value]="user.id">{{ user.fullName }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Lugar:</label>
        <input type="text" [(ngModel)]="expenseFilterPlace" placeholder="Ej: Ã‰xito, Carulla..." class="filter-input">
      </div>

      <div class="filter-group">
        <label>Desde:</label>
        <input type="date" [(ngModel)]="expenseFilterDateFrom" class="filter-input">
      </div>

      <div class="filter-group">
        <label>Hasta:</label>
        <input type="date" [(ngModel)]="expenseFilterDateTo" class="filter-input">
      </div>

      <button class="btn-link" (click)="clearExpenseFilters()">Limpiar</button>
    </div>

    <div class="filter-results" *ngIf="filteredMarketExpenses.length !== marketExpenses.length">
      Mostrando {{ filteredMarketExpenses.length }} de {{ marketExpenses.length }} gastos
    </div>
  </div>

  <app-skeleton [loading]="loadingMarketExpenses" [type]="'payment-table'"></app-skeleton>

  <div class="table-responsive" *ngIf="!loadingMarketExpenses && filteredMarketExpenses.length > 0">
    <table class="data-table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Lugar</th>
          <th>Responsable</th>
          <th>CategorÃ­a</th>
          <th>Monto</th>
          <th>Notas</th>
          <th class="actions-column">Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let expense of filteredMarketExpenses">
          <td data-label="Fecha">{{ expense.date | date: 'dd/MM/yyyy' }}</td>
          <td data-label="Lugar">{{ expense.place }}</td>
          <td data-label="Responsable">{{ expense.responsible.fullName }}</td>
          <td data-label="CategorÃ­a">
            <span class="badge">{{ expense.category || 'N/A' }}</span>
          </td>
          <td data-label="Monto">${{ expense.amount | number: '1.2-2' }}</td>
          <td data-label="Notas">
            <span class="expense-notes">{{ expense.notes || '-' }}</span>
          </td>

          <td class="actions-column" data-label="Acciones">
            <div class="action-buttons">
              <button class="btn-icon" (click)="openMarketExpenseModal(expense)" title="Editar">âœï¸</button>
              <button class="btn-icon btn-danger" (click)="deleteMarketExpense(expense.id)" title="Eliminar">ğŸ—‘ï¸</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="empty-state" *ngIf="!loadingMarketExpenses && filteredMarketExpenses.length === 0">
    <p>No hay gastos registrados todavÃ­a</p>
  </div>
</div>


      <!-- Users Tab -->
      <div *ngIf="activeTab === 'users' && authService.canManageUsers()" class="tab-content">
        <div class="tab-header">
          <h2>Usuarios</h2>
          <button class="btn-primary" (click)="openUserModal()">
            <span class="btn-icon-only">+</span>
            <span class="btn-text">Nuevo Usuario</span>
          </button>
        </div>

        <app-skeleton [loading]="loadingUsers" [type]="'employee-card'"></app-skeleton>

        <div class="cards-grid" *ngIf="!loadingUsers">
          <div *ngFor="let user of users" class="card">
            <div class="card-header">
              <h3>{{ user.fullName }}</h3>
              <span class="badge">
                {{ user.role === 'super_admin' ? 'Super Admin' : user.role === 'admin_house' ? 'Admin Casa' : 'Admin' }}
              </span>
            </div>
            <div class="card-body">
              <p><strong>Email:</strong> {{ user.email }}</p>
              <p *ngIf="currentUser?.role === 'super_admin' && user.houseId">
                <strong>Casa:</strong> {{ getHouseName(user.houseId) }}
              </p>
            </div>
            <div class="card-actions" *ngIf="user.id !== currentUser?.id">
              <button class="btn-sm" (click)="openUserModal(user)">âœï¸ Editar</button>
              <button class="btn-sm btn-danger" (click)="deleteUser(user.id)">ğŸ—‘ï¸ Eliminar</button>
            </div>
          </div>
        </div>

        <div class="empty-state" *ngIf="!loadingUsers && users.length === 0">
          <p>ğŸ‘¥ No hay usuarios registrados todavÃ­a</p>
        </div>
      </div>

      <!-- Houses Tab -->
      <div *ngIf="activeTab === 'houses' && currentUser?.role === 'super_admin'" class="tab-content">
        <div class="tab-header">
          <h2>Casas</h2>
          <button class="btn-primary" (click)="openHouseModal()">
            <span class="btn-icon-only">+</span>
            <span class="btn-text">Nueva Casa</span>
          </button>
        </div>

        <app-skeleton [loading]="loadingHouses" [type]="'employee-card'"></app-skeleton>

        <div class="cards-grid" *ngIf="!loadingHouses">
          <div *ngFor="let house of houses" class="card">
            <div class="card-header">
              <h3>{{ house.name }}</h3>
              <span class="badge">{{ house.slug }}</span>
            </div>
            <div class="card-body">
              <p *ngIf="house.description"><strong>DescripciÃ³n:</strong> {{ house.description }}</p>
              <p><strong>ID:</strong> {{ house.id }}</p>
            </div>
            <div class="card-actions">
              <button class="btn-sm" (click)="openHouseModal(house)">âœï¸ Editar</button>
              <button class="btn-sm btn-danger" (click)="deleteHouse(house.id)">ğŸ—‘ï¸ Eliminar</button>
            </div>
          </div>
        </div>

        <div class="empty-state" *ngIf="!loadingHouses && houses.length === 0">
          <p>ğŸ  No hay casas registradas todavÃ­a</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Employee Modal -->
<div class="modal" *ngIf="showEmployeeModal" (click)="showEmployeeModal = false">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingEmployee ? 'Editar' : 'Nueva' }} Empleada</h3>
      <button class="btn-close" (click)="showEmployeeModal = false">Ã—</button>
    </div>
    <form [formGroup]="employeeForm" (ngSubmit)="saveEmployee()">
      <div class="form-group">
        <label>Nombre Completo *</label>
        <input type="text" formControlName="fullName" class="form-control">
      </div>
      <div class="form-group">
        <label>Documento de Identidad *</label>
        <input type="text" formControlName="documentId" class="form-control">
      </div>
      <div class="form-group">
        <label>TelÃ©fono</label>
        <input type="tel" formControlName="phone" class="form-control">
      </div>
      <div class="form-group">
        <label>Salario Base *</label>
        <input type="number" formControlName="baseSalary" class="form-control" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="isActive">
          Activa
        </label>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="showEmployeeModal = false">Cancelar</button>
        <button type="submit" class="btn-primary" [disabled]="employeeForm.invalid || loading">
          {{ loading ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal" *ngIf="showPaymentModal" (click)="closePaymentModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingPayment ? 'Editar' : 'Nuevo' }} Pago</h3>
      <button class="btn-close" (click)="closePaymentModal()">Ã—</button>
    </div>
    <form [formGroup]="paymentForm" (ngSubmit)="savePayment()">
      <div class="form-group">
        <label>Fecha de Pago *</label>
        <input type="date" formControlName="paymentDate" class="form-control">
      </div>
      <div class="form-group">
        <label>Empleada *</label>
        <select formControlName="employeeId" class="form-control" (change)="onEmployeeChange($any($event.target).value)">
          <option value="">Seleccionar empleada</option>
          <option *ngFor="let emp of employees" [value]="emp.id">{{ emp.fullName }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Empleador *</label>
        <select formControlName="employerId" class="form-control">
          <option value="">Seleccionar empleador</option>
          <option *ngFor="let user of users" [value]="user.id">{{ user.fullName }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Salario Base (de la empleada)</label>
        <input type="number" formControlName="baseSalary" class="form-control readonly-input" min="0" step="0.01" readonly>
        <small class="form-hint">Este valor se trae automÃ¡ticamente del perfil de la empleada</small>
      </div>
      <div class="form-group">
        <label>Bonificaciones</label>
        <input type="number" formControlName="bonuses" class="form-control" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label>Deducciones</label>
        <input type="number" formControlName="deductions" class="form-control" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label>Notas</label>
        <textarea formControlName="notes" class="form-control" rows="3"></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closePaymentModal()">Cancelar</button>
        <button type="submit" class="btn-primary" [disabled]="paymentForm.invalid || loading">
          {{ loading ? 'Creando...' : 'Crear Pago' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- User Modal -->
<div class="modal" *ngIf="showUserModal" (click)="showUserModal = false">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingUser ? 'Editar' : 'Nuevo' }} Usuario</h3>
      <button class="btn-close" (click)="showUserModal = false">Ã—</button>
    </div>
    <form [formGroup]="userForm" (ngSubmit)="saveUser()">
      <div class="form-group" *ngIf="currentUser?.role === 'super_admin'">
        <label>Casa *</label>
        <select formControlName="houseId" class="form-control">
          <option value="">Seleccionar casa</option>
          <option *ngFor="let house of houses" [value]="house.id">{{ house.name }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Nombre Completo *</label>
        <input type="text" formControlName="fullName" class="form-control">
      </div>
      <div class="form-group">
        <label>Email *</label>
        <input type="email" formControlName="email" class="form-control">
      </div>
      <div class="form-group" *ngIf="!editingUser">
        <label>ContraseÃ±a *</label>
        <input type="password" formControlName="password" class="form-control">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="showUserModal = false">Cancelar</button>
        <button type="submit" class="btn-primary" [disabled]="userForm.invalid || loading">
          {{ loading ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Signature Modal -->
<div class="modal" *ngIf="showSignatureModal" (click)="closeSignatureModal()">
  <div class="modal-content modal-signature" (click)="$event.stopPropagation()">
    <app-signature-pad 
      (signatureSaved)="saveSignature($event)"
      (cancelled)="closeSignatureModal()">
    </app-signature-pad>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal" *ngIf="showChangePasswordModal" (click)="closeChangePasswordModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Cambiar ContraseÃ±a</h3>
      <button class="btn-close" (click)="closeChangePasswordModal()">Ã—</button>
    </div>
    <form [formGroup]="changePasswordForm" (ngSubmit)="changePassword()">
      <div class="form-group">
        <label>ContraseÃ±a Actual *</label>
        <input type="password" formControlName="currentPassword" class="form-control" placeholder="Ingrese su contraseÃ±a actual">
      </div>
      <div class="form-group">
        <label>Nueva ContraseÃ±a *</label>
        <input type="password" formControlName="newPassword" class="form-control" placeholder="MÃ­nimo 6 caracteres">
        <small class="form-hint" *ngIf="changePasswordForm.get('newPassword')?.invalid && changePasswordForm.get('newPassword')?.touched">
          La contraseÃ±a debe tener al menos 6 caracteres
        </small>
      </div>
      <div class="form-group">
        <label>Confirmar Nueva ContraseÃ±a *</label>
        <input type="password" formControlName="confirmPassword" class="form-control" placeholder="Repita la nueva contraseÃ±a">
        <small class="form-hint error" *ngIf="changePasswordForm.get('confirmPassword')?.hasError('mismatch') && changePasswordForm.get('confirmPassword')?.touched">
          Las contraseÃ±as no coinciden
        </small>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeChangePasswordModal()">Cancelar</button>
        <button type="submit" class="btn-primary" [disabled]="changePasswordForm.invalid || loading">
          {{ loading ? 'Guardando...' : 'Cambiar ContraseÃ±a' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Market Expense Modal -->
<div class="modal" *ngIf="showMarketExpenseModal" (click)="closeMarketExpenseModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingMarketExpense ? 'Editar' : 'Nuevo' }} Gasto de Mercado</h3>
      <button class="btn-close" (click)="closeMarketExpenseModal()">Ã—</button>
    </div>
    <form [formGroup]="marketExpenseForm" (ngSubmit)="saveMarketExpense()">
      <div class="form-group">
        <label>Fecha *</label>
        <input type="date" formControlName="date" class="form-control">
      </div>
      <div class="form-group">
        <label>Lugar *</label>
        <input type="text" formControlName="place" class="form-control" placeholder="Ej: Ã‰xito, Carulla, D1...">
      </div>
      <div class="form-group">
        <label>Responsable * (QuiÃ©n hizo la compra)</label>
        <select formControlName="responsibleId" class="form-control">
          <option value="">Seleccionar responsable</option>
          <option *ngFor="let user of users" [value]="user.id">{{ user.fullName }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>CategorÃ­a</label>
        <select formControlName="category" class="form-control">
          <option value="mercado">Mercado</option>
          <option value="servicios">Servicios</option>
          <option value="otros">Otros</option>
        </select>
      </div>
      <div class="form-group">
        <label>Monto * ($)</label>
        <input type="number" formControlName="amount" class="form-control" min="0" step="0.01" placeholder="0.00">
      </div>
      <div class="form-group">
        <label>Notas (Opcional)</label>
        <textarea formControlName="notes" class="form-control" rows="3" placeholder="Detalles adicionales..."></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeMarketExpenseModal()">Cancelar</button>
        <button type="submit" class="btn-primary" [disabled]="marketExpenseForm.invalid || loading">
          {{ loading ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- House Modal -->
<div class="modal" *ngIf="showHouseModal" (click)="closeHouseModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingHouse ? 'Editar' : 'Nueva' }} Casa</h3>
      <button class="btn-close" (click)="closeHouseModal()">Ã—</button>
    </div>
    <form [formGroup]="houseForm" (ngSubmit)="saveHouse()">
      <div class="form-group">
        <label>Nombre *</label>
        <input type="text" formControlName="name" class="form-control" placeholder="Ej: Casa Principal">
      </div>
      <div class="form-group">
        <label>Slug * (identificador Ãºnico)</label>
        <input type="text" formControlName="slug" class="form-control" placeholder="Ej: casa-principal">
        <small class="form-hint">Solo letras minÃºsculas, nÃºmeros y guiones</small>
      </div>
      <div class="form-group">
        <label>DescripciÃ³n</label>
        <textarea formControlName="description" class="form-control" rows="3" placeholder="DescripciÃ³n opcional..."></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeHouseModal()">Cancelar</button>
        <button type="submit" class="btn-primary" [disabled]="houseForm.invalid || loading">
          {{ loading ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </form>
  </div>
</div>